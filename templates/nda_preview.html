<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NDA Preview | LawChatAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* Watermark */
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 5rem;
      color: rgba(0,0,0,0.05);
      pointer-events: none;
      user-select: none;
      z-index: 0;
    }

    .clause {
      position: relative;
      padding-left: 1rem;
      transition: all 0.2s ease;
    }

    .clause.edited {
      border-left: 4px solid #2563eb;
      background-color: #fffbea;
    }

    .clause-actions {
      position: absolute;
      top: 0;
      right: 0;
      display: flex;
      gap: 0.5rem;
    }

    [contenteditable="true"]:focus {
      outline: none;
      background-color: #fffdf5;
    }

    body {
      font-family: 'Poppins', sans-serif;
    }

    @media print {
      .no-print,
      .watermark,
      .clause-actions,
      .edited-badge {
        display: none;
      }
      body {
        background: white;
      }

    }
  </style>
</head>

<body class="bg-gray-100 text-gray-900">

<!-- HEADER -->
<header class="bg-gradient-to-r from-purple-800 to-purple-600 text-white sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">

    <div>
      <h1 class="text-xl font-semibold tracking-wide">
        <a href="https://lawchatai.in" class="hover:opacity-80 cursor-pointer">
          LawChat AI
        </a>
      </h1>
      <p class="text-sm opacity-90">NDA Preview</p>
    </div>


    <div class="flex items-center gap-3">

      <a
        class="bg-white text-purple-700 px-3 py-2 rounded-lg font-medium hover:bg-gray-100 transition flex items-center justify-center"
        aria-label="Profile"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card-icon lucide-credit-card"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>

        <span class="text-sm font-semibold">
          {% if account_type == "Premium_contract" %}
            Unlimited
          {% else %}
            {{ credit_contract }}
          {% endif %}
        </span>
      </a>

      <!-- Profile -->
      <a
        href="https://lawchatai.in/profile"
        class="bg-white text-purple-700 px-3 py-2 rounded-lg font-medium hover:bg-gray-100 transition flex items-center justify-center"
        aria-label="Profile"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      </a>

      <!-- My Documents -->
      <a
        href="{{ url_for('nda.my_documents') }}"
        class="bg-white text-purple-700 px-3 py-2 rounded-lg font-medium hover:bg-gray-100 transition flex items-center gap-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="15" cy="19" r="2"/>
          <path d="M20.9 19.8A2 2 0 0 0 22 18V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h5.1"/>
          <path d="M15 11v-1"/>
          <path d="M15 17v-2"/>
        </svg>

      </a>


    </div>
  </div>
</header>


<div class="watermark">DRAFT ¬∑ LawChatAI</div>

<div class="max-w-5xl mx-auto mt-24 mb-10 px-4">

  <div class="bg-white shadow-lg rounded-lg px-10 py-12">

    <h1 class="text-2xl font-bold text-center mb-10">
      Employee Non-Disclosure Agreement
    </h1>

    <!-- CLAUSE 1 -->
    <div class="clause mb-6" data-original="{{ nda_text }}">
      <div class="clause-actions no-print">
        <button onclick="toggleEdit(this)"
          class="text-xs px-2 py-1 border rounded text-blue-600">
          ‚úèÔ∏è Edit
        </button>
        <span class="edited-badge hidden text-xs text-blue-600 font-semibold">
          Edited
        </span>
      </div>

      <p class="font-semibold mb-2">1. Confidential Information</p>

      <div class="clause-text text-sm leading-7 whitespace-pre-line"
           contenteditable="false">
        {{ nda_text }}
      </div>
    </div>


  </div>

  <!-- ACTION BAR -->
  <div class="no-print bg-white shadow rounded-lg mt-6 p-6 flex justify-between items-center">

    <p class="text-sm text-gray-600">
      üîí Locked clauses are read-only ¬∑ ‚úèÔ∏è Edit to customize
    </p>

    <form method="POST"
      action="/nda/generate-pdf"
      target="downloadFrame"
      onsubmit="handlePdfSubmit(event)"
      class="flex items-center gap-4">

      <input type="hidden" name="nda_text" id="finalNdaText">

      <label class="flex items-center gap-2 text-sm">
        <input type="checkbox" required class="accent-blue-600">
        I approve this NDA
      </label>

    <button type="submit" id="generatePdfBtn"
        title="You need more credits or upgrade your plan"
        class="px-6 py-3 bg-blue-600 text-white rounded-lg
               flex items-center justify-center gap-3
               disabled:opacity-60 disabled:cursor-not-allowed">
        <span id="pdfBtnText">Generate PDF</span>

        <!-- Spinner -->
        <svg id="pdfLoader" class="hidden w-5 h-5 animate-spin" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10"
            stroke="currentColor" stroke-width="4" fill="none" />
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
        </svg>
      </button>

    </form>

  </div>

</div>

<script>
  function toggleEdit(btn) {
    const clause = btn.closest(".clause");
    const text = clause.querySelector(".clause-text");
    const badge = clause.querySelector(".edited-badge");

    const isEditable = text.getAttribute("contenteditable") === "true";

    if (isEditable) {
      text.setAttribute("contenteditable", "false");
      btn.textContent = "‚úèÔ∏è Edit";

      if (text.dataset.original && text.innerText !== text.dataset.original) {
        clause.classList.add("edited");
        badge.classList.remove("hidden");
      }
    } else {
      text.dataset.original = text.innerText;
      text.setAttribute("contenteditable", "true");
      btn.textContent = "üîí Lock";
      text.focus();
    }
  }

  function collectFinalText() {
    const clauses = document.querySelectorAll(".clause-text");
    let finalText = "";

    clauses.forEach((c, i) => {
      finalText += `Clause ${i + 1}\n${c.innerText}\n\n`;
    });

    document.getElementById("finalNdaText").value = finalText.trim();
  }

  function handlePdfSubmit(e) {
    collectFinalText();

    const pdfBtn = document.getElementById("generatePdfBtn");
    const pdfBtnText = document.getElementById("pdfBtnText");
    const pdfLoader = document.getElementById("pdfLoader");

    pdfBtn.disabled = true;
    pdfBtnText.textContent = "Generating PDF‚Ä¶";
    pdfLoader.classList.remove("hidden");

    // ‚úÖ Because page does NOT reload (iframe),
    // we can safely reset UI
    setTimeout(() => {
      pdfBtn.disabled = false;
      pdfBtnText.textContent = "Generate PDF";
      pdfLoader.classList.add("hidden");
    }, 15000); // realistic PDF time
  }

  document.addEventListener("DOMContentLoaded", () => {
    const accountType = "{{ account_type }}";           // free, premium, premium_contract
    const creditContract = {{ credit_contract }};      // number from Jinja

    const pdfBtn = document.getElementById("generatePdfBtn");
    const pdfBtnText = document.getElementById("pdfBtnText");

    // Default: button enabled
    let disableBtn = false;
    let btnMessage = "Generate PDF";

    if (accountType === "Free") {
      disableBtn = true;
      btnMessage = "Upgrade to Access";
    }
    else if (accountType === "Premium" && creditContract < 15) {
      disableBtn = true;
      btnMessage = "15 Credits Required to Generate PDF";
    }
    // premium_contract‚Üí full access, do nothing

    pdfBtn.disabled = disableBtn;
    pdfBtnText.textContent = btnMessage;

    if (disableBtn) {
      pdfBtn.classList.add("disabled:opacity-60", "disabled:cursor-not-allowed");
    }
  });

</script>

<iframe
  name="downloadFrame"
  style="display:none;"
></iframe>

</body>
</html>
